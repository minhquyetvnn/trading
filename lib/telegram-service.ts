import axios from 'axios';

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;

class TelegramService {
  private apiUrl: string;

  constructor() {
    this.apiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}`;
  }

  async sendMessage(text: string, parseMode: 'HTML' | 'Markdown' = 'HTML'): Promise<boolean> {
    if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
      console.log('‚ö†Ô∏è Telegram not configured');
      return false;
    }

    try {
      await axios.post(`${this.apiUrl}/sendMessage`, {
        chat_id: TELEGRAM_CHAT_ID,
        text,
        parse_mode: parseMode
      });
      return true;
    } catch (error) {
      console.error('‚ùå Telegram send error:', error);
      return false;
    }
  }

  async notifyNewSignal(signal: any): Promise<void> {
    const emoji = signal.action === 'BUY' ? 'üü¢' : 'üî¥';
    const qualityEmoji = 
      signal.quality?.rating === 'EXCELLENT' ? 'üíé' :
      signal.quality?.rating === 'GOOD' ? '‚ú®' : '‚ö°';

    const message = `
${qualityEmoji} <b>${signal.quality?.rating || 'NEW'} SIGNAL</b>

${emoji} <b>${signal.action} ${signal.coin}</b>
Confidence: <b>${signal.confidence}%</b>
Quality Score: <b>${signal.quality?.score || 0}/100</b>

üí∞ <b>Entry & Targets:</b>
Entry: $${signal.entryPrice.toLocaleString()}
Stop Loss: $${signal.stopLoss.toLocaleString()} (-${((Math.abs(signal.stopLoss - signal.entryPrice) / signal.entryPrice) * 100).toFixed(2)}%)
TP1: $${signal.takeProfit1.toLocaleString()} (+${((signal.takeProfit1 - signal.entryPrice) / signal.entryPrice * 100).toFixed(2)}%)
TP2: $${signal.takeProfit2.toLocaleString()} (+${((signal.takeProfit2 - signal.entryPrice) / signal.entryPrice * 100).toFixed(2)}%)
TP3: $${signal.takeProfit3.toLocaleString()} (+${((signal.takeProfit3 - signal.entryPrice) / signal.entryPrice * 100).toFixed(2)}%)

üìä <b>Position:</b>
Size: ${signal.positionSize} ${signal.coin}
Capital: $${signal.capitalAllocated}
R:R: ${signal.riskRewardRatio}:1

üí° <b>Reasoning:</b>
${signal.reasoning}

‚è∞ ${new Date().toLocaleString()}
    `.trim();

    await this.sendMessage(message);
  }

  async notifyTPHit(signal: any, tpLevel: number): Promise<void> {
    const tpPrice = signal[`takeProfit${tpLevel}`];
    const message = `
üéâ <b>TP${tpLevel} HIT!</b>

<b>${signal.coin}</b> reached Target ${tpLevel}
Price: $${tpPrice.toLocaleString()}

üí∞ <b>Profit:</b>
P/L: $${signal.pnlUSD.toFixed(2)}
ROI: +${signal.pnlPercentage.toFixed(2)}%

${tpLevel === 3 ? 'üèÜ All targets completed!' : `üìä Next target: TP${tpLevel + 1} at $${signal[`takeProfit${tpLevel + 1}`].toLocaleString()}`}

‚è∞ ${new Date().toLocaleString()}
    `.trim();

    await this.sendMessage(message);
  }

  async notifySLHit(signal: any): Promise<void> {
    const message = `
‚ö†Ô∏è <b>STOP LOSS HIT</b>

<b>${signal.coin}</b> stopped out
Price: $${signal.currentPrice.toLocaleString()}

üí∏ <b>Loss:</b>
P/L: -$${Math.abs(signal.pnlUSD).toFixed(2)}
ROI: ${signal.pnlPercentage.toFixed(2)}%

Risk management protected your capital.

‚è∞ ${new Date().toLocaleString()}
    `.trim();

    await this.sendMessage(message);
  }

  async notifyAutoGenerated(count: number, excellentCount: number, goodCount: number): Promise<void> {
    const message = `
ü§ñ <b>AUTO-GENERATED SIGNALS</b>

Generated: <b>${count} quality signals</b>
üíé EXCELLENT: ${excellentCount}
‚ú® GOOD: ${goodCount}

Check your dashboard to review and trade!

‚è∞ ${new Date().toLocaleString()}
    `.trim();

    await this.sendMessage(message);
  }

  async notifyDailySummary(portfolio: any): Promise<void> {
    const isProfit = portfolio.netProfit >= 0;
    const emoji = isProfit ? 'üìà' : 'üìâ';

    const message = `
${emoji} <b>DAILY SUMMARY</b>

üí∞ <b>Portfolio:</b>
Current Capital: $${portfolio.currentCapital.toFixed(2)}
Net Profit: ${isProfit ? '+' : ''}$${portfolio.netProfit.toFixed(2)} (${portfolio.netProfitPercentage.toFixed(2)}%)

üìä <b>Performance:</b>
Total Trades: ${portfolio.totalTrades}
Win Rate: ${portfolio.winRate.toFixed(1)}%
Profit Factor: ${portfolio.profitFactor.toFixed(2)}

‚úÖ Winning: ${portfolio.winningTrades} (+$${portfolio.totalProfit.toFixed(2)})
‚ùå Losing: ${portfolio.losingTrades} (-$${portfolio.totalLoss.toFixed(2)})

üéØ Active Positions: ${portfolio.activePositions}

${isProfit ? 'üéâ Great job today!' : 'üí™ Tomorrow is a new opportunity!'}

‚è∞ ${new Date().toLocaleString()}
    `.trim();

    await this.sendMessage(message);
  }
}

export const telegramService = new TelegramService();